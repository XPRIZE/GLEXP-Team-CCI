<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pubbly Console</title>
    <link rel="stylesheet" href="../includes/webix/webix.css"/>
    <link rel="stylesheet" href="../includes/dropzone.css"/>
    <script src="../includes/jquery.js"></script>
    <script src="../includes/webix/webix_debug.js"></script>
    <script src="../includes/dropzone.js"></script>

    <style>
        #uploadParent, #reuploadParent {
            height: 200px;
            width: 200px;
            display: block;
            margin: auto;
            border: 2px dashed grey;
        }
    </style>
    <style>
        .selected button:hover {
            background-color: green !important;
        }

        .selected button {
            background-color: #00a000 !important;
        }
    </style>
    <link rel="styleSheet" href="../css/webixPersonalModifications.css"/>
    <script src="../js/deletePrompt.js"></script>
</head>
<body>
<script>
    window.uploadParentDropzoneAttached = false;
    window.reuploadParentDropzoneAttached = false;
    window.newSeriesTimeout = false;

    var header = {
        view: "toolbar",
        height: 55,
        autoWidth: true,
        cols: [
            {
                view: "button", value: "Home", width: 80, on: {
                onItemClick: function () {
                    window.location.href = "../index.php";
                }
            }
            },
            {
                view: "button", value: "Help", width: 80, on: {
                onItemClick: function () {
                    window.location.href = "help.php";
                }
            }
            },
            {
                view: "label",
                template: "<p class='toolbarCenterLabel'>Series Select</p>"
            },
            {width: 80,},
            {
                view: "button", value: "Logout", width: 80, on: {
                onItemClick: function () {
                    window.location.href = "../logout.php";
                }
            }
            }
        ]
    };
    var elem = {
        view: "scrollview",
        width: "100%",
        body: {
            rows: [
                header,
                {
                    view: "tabview",
                    id: "editAndCreateTab",
                    cells: [
                        {
                            header: "Edit Series",
                            rows: [
                                {
                                    height: 50, cols: [
                                    {
                                        cols: [
                                            {view: "label", label: "Sort series: ", width: 85},
                                            {
                                                view: "button",
                                                id: "sortByName",
                                                value: "Name",
                                                width: 75,
                                                css: "selected",
                                                on: {
                                                    onItemClick: function () {
                                                        // Ugly right? If the thing is selected, toggle the direction. If not, keep the same direction.
                                                        if ($($$("sortByName").$view).find("button")[0].innerHTML.charAt(0) == "⇑") {
                                                            if ($($$("sortByName").$view).hasClass("selected")) {
                                                                reorderSeriesList("name", "desc");
                                                                setWebixInnerById("sortByName", "&#x21D3; Name");
                                                            } else {
                                                                reorderSeriesList("name", "asc");
                                                                setWebixInnerById("sortByName", "&#x21D1; Name");
                                                            }
                                                        } else {
                                                            if ($($$("sortByName").$view).hasClass("selected")) {
                                                                reorderSeriesList("name", "asc");
                                                                setWebixInnerById("sortByName", "&#x21D1; Name");
                                                            } else {
                                                                reorderSeriesList("name", "desc");
                                                                setWebixInnerById("sortByName", "&#x21D3; Name");
                                                            }
                                                        }
                                                        $($$("sortByDate").$view).removeClass("selected");
                                                        $($$("sortByName").$view).addClass("selected");

                                                        $$("seriesName").setValue("");
                                                        $$("seriesName").refresh();
                                                        $$("startSwapping").disable();
                                                        $$("deleteSeries").disable();
                                                        $$("backupSeries").disable();
                                                        $$("downloadParent").disable();
                                                        $$("renameSeries").disable();
                                                        $$("goSeries").disable();
                                                        $$('reuploadParentDZ').collapse();
                                                        for (var i = $$("childSelectorDropDown").count(); i > 0; i--) {
                                                            $$("childSelectorDropDown").remove(i);
                                                        }
                                                    }
                                                }
                                            },
                                            {
                                                view: "button", id: "sortByDate", value: "Date", width: 75, on: {
                                                onItemClick: function () {
                                                    if ($($$("sortByDate").$view).find("button")[0].innerHTML.charAt(0) == "⇑") {
                                                        if ($($$("sortByDate").$view).hasClass("selected")) {
                                                            reorderSeriesList("date", "desc");
                                                            setWebixInnerById("sortByDate", "&#x21D3; Date");
                                                        } else {
                                                            reorderSeriesList("date", "asc");
                                                            setWebixInnerById("sortByDate", "&#x21D1; Date");
                                                        }
                                                    } else {
                                                        if ($($$("sortByDate").$view).hasClass("selected")) {
                                                            reorderSeriesList("date", "asc");
                                                            setWebixInnerById("sortByDate", "&#x21D1; Date");
                                                        } else {
                                                            reorderSeriesList("date", "desc");
                                                            setWebixInnerById("sortByDate", "&#x21D3; Date");
                                                        }
                                                    }
                                                    $($$("sortByName").$view).removeClass("selected");
                                                    $($$("sortByDate").$view).addClass("selected");

                                                    $$("seriesName").setValue("");
                                                    $$("seriesName").refresh();
                                                    $$("startSwapping").disable();
                                                    $$("deleteSeries").disable();
                                                    $$("backupSeries").disable();
                                                    $$("downloadParent").disable();
                                                    $$("renameSeries").disable();
                                                    $$("goSeries").disable();
                                                    $$('reuploadParentDZ').collapse();
                                                    for (var i = $$("childSelectorDropDown").count(); i > 0; i--) {
                                                        $$("childSelectorDropDown").remove(i);
                                                    }
                                                }
                                            }
                                            },
                                            {},
                                        ]
                                    },
                                    {},
                                ]
                                },
                                {
                                    cols: [
                                        // seriesList goes here,
                                        // seriesActions goes here
                                    ]
                                },
                            ],
                        },
                        {
                            id: "createTab",
                            header: "New Series",
                            cols: [
                                {gravity: 1},
                                {
                                    gravity: 5,
                                    maxWidth: 400,
                                    autoheight: true,
                                    rows: [
                                        {height: 10,},
                                        {
                                            header: "Step 1", collapsed: false, body: {
                                            view: "form",
                                            gravity: 1,
                                            elements: [
                                                {
                                                    view: "text",
                                                    label: "Name Series: ",
                                                    id: "newSeriesName",
                                                    labelWidth: 150,
                                                    on: {
                                                        onTimedKeyPress: function () {
                                                            var requestName = $$("newSeriesName").getValue();
                                                            if (requestName) {
                                                                if (newSeriesTimeout) {
                                                                    window.clearTimeout(newSeriesTimeout);
                                                                }
                                                                $$("newSeries").disable();
                                                                $$("newSeries").setValue("Checking...");
                                                                $$("newSeries").refresh();
                                                                window.newSeriesTimeout = window.setTimeout(function () {
                                                                    var jqxhr = $.ajax("../ajax/check/checkSeriesName.php?name=" + requestName)
                                                                            .done(function (ret) {
                                                                                if (ret == "") {
                                                                                    $$("newSeries").enable();
                                                                                    $$("newSeries").setValue("Create new series");
                                                                                    $$("newSeries").refresh();
                                                                                } else {
                                                                                    $$("newSeries").disable();
                                                                                    $$("newSeries").setValue("Name taken");
                                                                                    $$("newSeries").refresh();
                                                                                }
                                                                            })
                                                                            .fail(function () {
                                                                                alert("error");
                                                                            })
                                                                }, 500);
                                                            } else {
                                                                $$("newSeries").disable();
                                                                $$("newSeries").setValue("Enter a name");
                                                                $$("newSeries").refresh();
                                                            }
                                                        }
                                                    }
                                                },
                                                {
                                                    view: "button",
                                                    id: "newSeries",
                                                    value: "Enter a name",
                                                    disabled: true,
                                                    on: {
                                                        onItemClick: function () {
                                                            $$("newSeriesName").disable();
                                                            $$(this).disable();
                                                            $$(this).setValue("Please wait...");
                                                            $$(this).refresh();
                                                            var requestName = $$("newSeriesName").getValue();
                                                            if (requestName) {
                                                                // Check one last time, just to be safe and stuff and things and
                                                                $.ajax("../ajax/check/checkSeriesName.php?name=" + requestName).done(function (ret) {
                                                                    if (ret == "") {
                                                                        $.ajax("../ajax/new/newSeries.php?name=" + requestName).done(function (ret) {
                                                                            if (ret == "true" || ret == 1) {
                                                                                window.newSeriesName = requestName;
                                                                                $$('uploadParentDZ').enable();
                                                                                $$('uploadParentDZ').expand();
                                                                                attachDropzoneEvents(requestName, "uploadParent", function () {
                                                                                    $$('editChildren').enable();
                                                                                    $$('editChildrenCont').enable();
                                                                                    $$('editChildrenCont').expand();
                                                                                });
                                                                                $$("newSeries").disable();
                                                                                $$("newSeries").setValue("Upload parent");
                                                                                $$("newSeries").refresh();
                                                                                $$('uploadParentDZ').enable();
                                                                                $$('uploadParentDZ').expand();
                                                                            } else {
                                                                                console.error(ret);
                                                                            }
                                                                        });
                                                                    } else {
                                                                        $$("newSeries").disable();
                                                                        $$("newSeries").setValue("Name taken");
                                                                        $$("newSeries").refresh();
                                                                        $$("newSeriesName").enable();
                                                                    }
                                                                });
                                                            } else {
                                                                $$(this).enable();
                                                                $$(this).setValue("Enter a name");
                                                                $$("newSeriesName").enable();
                                                            }
                                                        }
                                                    }
                                                },
                                            ]
                                        },
                                        },
                                        {
                                            header: "Step 2",
                                            id: "uploadParentDZ",
                                            height: 260,
                                            disabled: true,
                                            collapsed: true,
                                            body: {
                                                id: "uploadParent",
                                                template: '<form action="../ajax/upload/uploadParent.php" class="dropzone" id="uploadParent"><div class="dz-message" data-dz-message><span>Upload Zip file</span></div></form>',
                                                gravity: 1,
                                                minHeight: 220,
                                            }
                                        },
                                        {
                                            header: "Step 3",
                                            id: "editChildrenCont",
                                            collapsed: true,
                                            disabled: true,
                                            body: {
                                                view: "form",
                                                elements: [
                                                    {
                                                        view: "button",
                                                        id: "editChildren",
                                                        value: "Go swap interface",
                                                        disabled: true,
                                                        on: {
                                                            onItemClick: function () {
                                                                window.location.href = window.newSeriesName + "/swap.php";
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {height: 10,},
                                    ]
                                },
                                {gravity: 1},
                            ],
                        },
                    ]
                },
            ]
        }
    };

    function getSeries(callback) {
        /*
         var ret = [{"ID": 7, "name": "Food", "children": ["Apples", "Banana", "Cucumbers"]}, {
         "ID": 8,
         "name": "Numbers",
         "children": []
         }, {"ID": 9, "name": "Letters", "children": []}, {"ID": 10, "name": "TestSeries", "children": []}, {
         "ID": 11,
         "name": "asdf",
         "children": []
         }, {"ID": 12, "name": "a", "children": []}, {"ID": 13, "name": "b", "children": []}, {
         "ID": 14,
         "name": "qwerty",
         "children": []
         }, {"ID": 15, "name": "qweryr", "children": []}, {"ID": 16, "name": "qrweqrwerqew", "children": []}, {
         "ID": 17,
         "name": "dfch",
         "children": []
         }];
         */
        $.ajax({
            type: 'get',
            url: '../ajax/get/getSwapAppSeriesList.php',
            success: function (ret) {
                if (ret.substring(0, 6) == "<br />") {
                    document.body.innerHTML = ret;
                } else {
                    var obj = window.eval(ret); // Maybe have to find a better eval with a third party thingy later on.
                    callback(obj);
                }
            }
        })
    }

    function reorderSeriesList(type, dir) {
        var ids = $$("seriesList").data.order.slice(); // array of ids, slice to dup not point
        var objs = $$("seriesList").data.pull; // Objects (named their ids) and the props
        var newOrder = [];
        var newObjs = [];
        if (type == "date") {
            for (var s in objs) {
                newOrder[objs[s].ID] = objs[s].id;
            }
            if (dir == "desc") {
                for (var s = 0; s < newOrder.length; s++) {
                    if (newOrder[s]) {
                        newObjs.push(objs[newOrder[s]]);
                    }
                }
            } else if (dir == "asc") {
                for (var s = newOrder.length; s >= 0; s--) {
                    if (newOrder[s]) {
                        newObjs.push(objs[newOrder[s]]);
                    }
                }
            }
        } else if (type == "name") {
            for (var o in objs) {
                newObjs.push(objs[o]);
            }
            ;
            if (dir == "asc") {
                newObjs.sort(function (a, b) {
                    var textA = a.name.toUpperCase();
                    var textB = b.name.toUpperCase();
                    return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
                });
            } else if (dir == "desc") {
                newObjs.sort(function (a, b) {
                    var textA = a.name.toUpperCase();
                    var textB = b.name.toUpperCase();
                    return (textA > textB) ? -1 : (textA < textB) ? 1 : 0;
                });
            }
            // TODO: Figure out how the hell sort functions work.
        }

        // Expecting a sorted newObjs here
        if (newObjs.length) {
            for (var s = 0; s < ids.length; s++) {
                $$("seriesList").remove(ids[s]);
            }
            for (var s = 0; s < newObjs.length; s++) {
                $$("seriesList").add(newObjs[s]);
            }
            $$("seriesList").refresh();
        }
    }

    getSeries(function (ret) {
        var seriesData = ret;

        for (var s = 0; s < seriesData.length; s++) {
            seriesData[s].length = seriesData[s].children.length;
        }
        var seriesList = {
            header: "Series", body: {
                view: "list",
                id: "seriesList",
                scroll: "y",
                template: "#name#: #length# children", // Maybe add "Last modified" or something.
                select: "multiselect",
                data: seriesData,
                on: {
                    onItemClick: function (id) {
                        var obj = this.getItem(id);
                        var seriesName = obj.name;
                        window.selectedSeries = seriesName;
                        var seriesKids = obj.children;
                        // seriesName
                        $$("seriesName").setValue(seriesName);
                        $$("seriesName").refresh();
                        $$("startSwapping").enable();
                        $$("downloadParent").enable();
                        $$("deleteSeries").enable();
                        $$("backupSeries").enable();
                        $$("renameSeries").enable();
                        $$("goSeries").enable();


                        for (var i = $$("childSelectorDropDown").count(); i > 0; i--) {
                            $$("childSelectorDropDown").remove(i);
                        }
                        $$("childSelectorDropDown").add({id: 1, value: " -- Choose -- "}, 0);
                        for (var i = 1; i < seriesKids.length + 1; i++) {
                            $$("childSelectorDropDown").add({id: i + 1, value: seriesKids[i - 1]}, i);
                        }
                        $$("childSelector").setValue(1);
                        $$("childSelectorDropDown").refresh();
                        $$("childSelector").refresh();

                        $$("reuploadParentDZ").expand();
                        attachDropzoneEvents(seriesName, "reuploadParent", function () {
                            // Callback is what happens after a successful reupload
                            window.location.href = window.location.href;
                        });
                    }
                }
            }
        };

        var seriesActions = {
            header: "Actions", id: "actions", body: {
                id: "actionsBody",
                minHeight: 777, // body height - 237
                rows: [
                    {
                        cols: [
                            {view: "label", label: "Parent:", align: "center", gravity: 1},
                            {
                                view: "text",
                                id: "seriesName",
                                value: "",
                                gravity: 3,
                                inputAlign: "center",
                                disabled: true
                            },
                            {
                                view: "button", id: "renameSeries", value: "Rename", gravity: 1.5, disabled: true, on: {
                                onItemClick: function () {
                                    var newName = window.prompt("Enter a new name for the series");
                                    if (newName) {
                                        var THIS = this;
                                        $$(this).disable();
                                        $$(this).setValue("Please wait...");
                                        $$(this).refresh();
                                        $.ajax({
                                            type: 'get',
                                            url: '../ajax/rename/renameSeries.php',
                                            data: {"oldName": window.selectedSeries, "newName": newName},
                                            success: function (ret) {
                                                if (ret == "done") {
                                                    window.location.href = window.location.href;
                                                } else {
                                                    window.alert(ret + "</br>Please contact support");
                                                    document.body.innerHTML = ret;
                                                }
                                            }
                                        })
                                    }
                                }
                            }
                            },
                            {
                                view: "button", id: "goSeries", value: "View", gravity: 1.5, disabled: true, on: {
                                onItemClick: function () {
                                    if (window.selectedSeries) {
                                        /*
                                         var loc = window.selectedSeries + "/index.php";
                                         window.location.href = loc;
                                         */
                                        webix.message("Coming soon. Maybe. Not really sure what 'A series' should look like... but I may have some use for this button and I don't want to have to restyle");
                                    } else {
                                        $$(this).disable();
                                    }
                                }
                            }
                            },
                        ]
                    },
                    {
                        cols: [
                            {view: "label", label: "Child: ", gravity: 1, align: "center"},
                            {
                                view: "combo", id: "childSelector", gravity: 3, value: 1, options: {
                                body: {
                                    id: "childSelectorDropDown",
                                    data: [
                                        {id: 1, value: " -- Choose -- "},
                                    ],
                                    on: {
                                        'onItemClick': function (id) {
                                            var childName = this.getItem(id).value;
                                            if (childName == " -- choose -- ") {
                                                $$("goChild").disable();
                                                $$("renameChild").disable();
                                                $$("deleteChild").disable();
                                                window.selectedChild = false;
                                            } else {
                                                $$("goChild").enable();
                                                $$("renameChild").enable();
                                                $$("deleteChild").enable();
                                                window.selectedChild = childName;
                                            }
                                        }
                                    }
                                }
                            },
                            },
                            {
                                view: "button",
                                id: "deleteChild",
                                value: "Delete",
                                gravity: 1,
                                disabled: true,
                                css: "delete",
                                on: {
                                    onItemClick: function () {
                                        var url = "../ajax/delete/deleteChild.php?seriesName=" + window.selectedSeries + "&childName=" + window.selectedChild;
                                        deletePrompt(selectedChild, "child", url, false);
                                    }
                                }
                            },
                            {
                                view: "button", id: "renameChild", value: "Rename", gravity: 1, disabled: true, on: {
                                onItemClick: function () {
                                    var newName = window.prompt("Enter a new name for the series");
                                    if (newName) {
                                        var THIS = this;
                                        $$(this).disable();
                                        $$(this).setValue("Please wait...");
                                        $$(this).refresh();
                                        $.ajax({
                                            type: 'get',
                                            url: '../ajax/rename/renameChild.php',
                                            data: {
                                                "series": window.selectedSeries,
                                                "oldName": window.selectedChild,
                                                "newName": newName
                                            },
                                            success: function (ret) {
                                                if (ret == "done") {
                                                    window.location.href = window.location.href;
                                                } else {
                                                    window.alert(ret + "</br>Please contact support");
                                                    document.body.innerHTML = ret;
                                                }
                                            }
                                        })
                                    }
                                }
                            }
                            },
                            {
                                view: "button", id: "goChild", value: "View", gravity: 1, disabled: true, on: {
                                onItemClick: function () {
                                    if (window.selectedChild) {
                                        var loc = window.selectedSeries + "/" + window.selectedChild + ".php";
                                        window.location.href = loc;
                                    } else {
                                        $$(this).disable();
                                    }
                                }
                            }
                            },
                        ]
                    },
                    {
                        cols: [
                            {},
                            {
                                view: "button",
                                id: "deleteSeries",
                                value: "Delete series",
                                width: 150,
                                css: "delete",
                                disabled: true,
                                on: {
                                    onItemClick: function () {
                                        var url = "../ajax/delete/deleteSeries.php?seriesName=" + selectedSeries;
                                        deletePrompt(selectedSeries, "series", url, false);
                                    }
                                }
                            },
                            {},
                            {
                                view: "button",
                                id: "startSwapping",
                                value: "Swap App",
                                width: 150,
                                disabled: true,
                                on: {
                                    onItemClick: function (item) {
                                        window.location.href = window.selectedSeries + "/swap.php";
                                    }
                                }
                            },
                            {},
                        ]
                    },
                    {
                        cols: [
                            {},
                            {
                                view: "button",
                                value: "Backup series",
                                id: "backupSeries",
                                disabled:true,
                                width: 150,
                                tooltip: "Save a local copy of the series (Images, audios, swaps, text fields, everything)",
                                on: {
                                    onItemClick: function () {
                                        var THIS = this;
                                        if ($$(this).getValue() == "Backup series") {
                                            $$(THIS).disable();
                                            $$(THIS).setValue("preparing...");
                                            $$(THIS).refresh();
                                            $.ajax("../ajax/misc/backupSeries.php?seriesName=" + window.selectedSeries).done(function (ret) {
                                                $$(THIS).setValue("Start download!");
                                                $$(THIS).refresh();
                                                $$(THIS).enable();
                                            });
                                        } else {
                                            var win = window.open("../downloads/" + window.selectedSeries + "_backup.zip", '_blank');
                                            win.focus();
                                            $$(THIS).setValue("Backup series");
                                            $$(THIS).refresh();
                                        }
                                    }
                                }
                            },
                            {},
                            {
                                view: "button",
                                value: "Download Parent",
                                id: "downloadParent",
                                disabled:true,
                                width: 150,
                                tooltip: "Download the last good parent.zip upload.",
                                on: {
                                    onItemClick: function () {
                                        var loc = "../zips/" + window.selectedSeries + "_parent.zip";
                                        $.ajax({
                                            url:loc,
                                            type:'HEAD',
                                            error: function()
                                            {
                                                window.location.href = window.selectedSeries + "/Parent.zip"; // boo last gen
                                            },
                                            success: function()
                                            {
                                                window.location.href = loc; // yay next gen
                                            }
                                        });
                                    }
                                }
                            },
                            {},
                        ]
                    },
                    {
                        header: "Reupload parent", id: "reuploadParentDZ", height: 260, collapsed: true,
                        body: {
                            id: "reuploadParent",
                            template: '<form action="../ajax/upload/uploadParent.php" class="dropzone" id="reuploadParent"><div class="dz-message" data-dz-message><span>Upload Zip file</span></div></form>',
                            gravity: 1,
                            minHeight: 220,
                        },
                    },
                ],
            },
        };


        elem.body.rows[1].cells[0].rows[1].cols.push(seriesList);
        elem.body.rows[1].cells[0].rows[1].cols.push(seriesActions);
        // console.log(elem);
        webix.ui(elem);
        resize();

        // Fucking dingbats get charescaped. So do it here manually.
        setWebixInnerById("sortByName", "&#x21D1; Name");
        setWebixInnerById("sortByDate", "&#x21D1; Date");
    });
    function setWebixInnerById(id, inner) {
        $($$(id).$view).find("button")[0].innerHTML = inner;
    }

    function attachDropzoneEvents(seriesName, dzid, callback) {
        console.log(dzid);
        if (!window[dzid + "DropzoneAttached"]) {
            new Dropzone("form#" + dzid, {url: "../ajax/upload/uploadParent.php?seriesName=" + seriesName});
            window[dzid + "DropzoneAttached"] = true;
        }
        Dropzone.forElement("#" + dzid).options.url = "../ajax/upload/uploadParent.php?seriesName=" + seriesName;
        window.parentDropzone = Dropzone.forElement("#" + dzid);
        window.parentDropzone.on("success", function (file, ret) {
            console.log(ret);
            if (ret.split(":")[0] == "error") {
                webix.message(initCaps(ret));
                this.removeAllFiles();
            } else {
                callback();
            }
        });
    }

    function initCaps(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }


    // nasty bit of work this.
    function resize() {
        var height = $(document.body).height();
        $$("actionsBody").define("minHeight", Math.max(415,height - 237));
        $$("actions").collapse();
        $$("actions").expand();
    }
    $(window).resize(resize);
</script>
</body>
</html>