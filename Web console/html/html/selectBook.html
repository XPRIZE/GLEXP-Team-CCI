<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pubbly Console</title>
  <link rel="stylesheet" href="../includes/webix/webix.css"/>
  <link rel="stylesheet" href="../includes/dropzone.css"></link>
  <script src="../includes/jquery.js"></script>
  <script src="../includes/webix/webix_debug.js"></script>
  <script src="../includes/dropzone.js"></script>

  <link rel="styleSheet" href="../css/webixPersonalModifications.css"/>
  <style>

  </style>
  <script src="../js/deletePrompt.js"></script>
</head>
<body>
<script>
  window.selectedBook = false, window.selectedBookID = false, window.newBookTimeout = false;


  var header = {
    view: "toolbar",
    height: 55,
    autoWidth: true,
    cols: [
      {
        view: "button", value: "Home", width: 80, on: {
        onItemClick: function () {
          window.location.href = "../index.php";
        }
      }
      },
      {
        view: "label",
        template: "<p class='toolbarCenterLabel'>Books</p>"
      },
      {
        view: "button", value: "Logout", width: 80, on: {
        onItemClick: function () {
          window.location.href = "../logout.php";
        }
      }
      }
    ]
  };

  var newBook = {
    header: "New book",
    id: "newBookCont",
    collapsed: true,
    body: {
      rows: [
        {
          id: "createTab",
          header: "New Book",
          cols: [
            {gravity: 1},
            {
              gravity: 5,
              maxWidth: 400,
              autoheight: true,
              rows: [
                {height: 10,},
                {
                  header: "Step 1", collapsed: false, body: {
                  view: "form",
                  gravity: 1,
                  elements: [
                    {
                      view: "text", label: "Name Book: ", id: "newBookName", labelWidth: 150, on: {
                      onTimedKeyPress: function () {
                        var requestName = $$("newBookName").getValue();
                        if (requestName) {
                          if (newBookTimeout) {
                            window.clearTimeout(newBookTimeout);
                          }
                          $$("newBook").disable();
                          $$("newBook").setValue("Checking...");
                          $$("newBook").refresh();
                          window.newBookTimeout = window.setTimeout(function () {
                            var jqxhr = $.ajax("../ajax/check/checkBookName.php?name=" + requestName)
                                .done(function (ret) {
                                  if (ret == "") {
                                    $$("newBook").enable();
                                    $$("newBook").setValue("Create new book");
                                    $$("newBook").refresh();
                                  } else {
                                    $$("newBook").disable();
                                    $$("newBook").setValue("Name taken");
                                    $$("newBook").refresh();
                                  }
                                })
                                .fail(function () {
                                  alert("error");
                                })
                          }, 500);
                        } else {
                          $$("newBook").disable();
                          $$("newBook").setValue("Enter a name");
                          $$("newBook").refresh();
                        }
                      }
                    }
                    },
                    {
                      view: "button", id: "newBook", value: "Enter a name", disabled: true, on: {
                      onItemClick: function () {
                        $$("newBookName").disable();
                        $$(this).disable();
                        $$(this).setValue("Please wait...");
                        $$(this).refresh();
                        var requestName = $$("newBookName").getValue();
                        if (requestName) {
                          // Check one last time, just to be safe and stuff and things and
                          $.ajax("../ajax/check/checkBookName.php?name=" + requestName).done(function (ret) {
                            if (ret == "") {
                              $.ajax("../ajax/new/newBook.php?name=" + requestName).done(function (ret) {
                                if (ret == "true" || ret == 1) {
                                  window.newBookName = requestName;
                                  $$('uploadBookCont').enable();
                                  $$('uploadBookCont').expand();
                                  $$("newBook").disable();
                                  $$("newBook").setValue("Upload book");
                                  $$("newBook").refresh();
                                  $$('uploadBookCont').enable();
                                  $$('uploadBookCont').expand();
                                  $$('uploadBook').enable();
                                  $$('uploadBook').data.upload = "../ajax/upload/uploadBook.php?bookName=" + requestName;
                                } else {
                                  console.error(ret);
                                }
                              });
                            } else {
                              $$("newBook").disable();
                              $$("newBook").setValue("Name taken");
                              $$("newBook").refresh();
                              $$("newBookName").enable();
                            }
                          });
                        } else {
                          $$(this).enable();
                          $$(this).setValue("Enter a name");
                          $$("newBookName").enable();
                        }
                      }
                    }
                    },
                  ]
                },
                },
                {
                  header: "Step 2",
                  id: "uploadBookCont",
                  height: 260,
                  disabled: true,
                  collapsed: true,
                  body: {
                    view: "form",
                    rows: [
                      {
                        view: "uploader",
                        id: "uploadBook",
                        disabled: true,
                        view: "uploader",
                        width: 200,
                        value: "Upload Book",
                        upload: "../ajax/upload/uploadBook.php",
                        on: {
                          onUploadComplete: function () {
                            webix.message("Upload complete!");
                            window.location.href = window.location.href;
                          }
                        },
                      },
                      {
                        view: "list", id: "mylist", type: "uploader", autoheight: true, borderless: true,
                      },
                    ]
                  }
                },
                {height: 10,},
              ]
            },
            {gravity: 1},
          ],
        },
      ]
    }
  };

  var selectBook = {
    header: "Select book",
    id: "selectBook",
    collapsed: false,
    body: {
      rows: [
        {
          id: "bookList",
          view: "datatable",
          select: "multiselect",
          width: "100%",
          autoheight: true,
          editable: true,
          scroll: false,
          columns: [
            {id: "ID", header: "", width: 50,},
            {id: "name", header: "Name", width: 200, editor: "text",},
            {id: "pages", header: "Pages", width: 100, editor: false,},
            {id: "longname", header: "Long Name", fillspace: true, editor: "text",},
          ],
          url:"../ajax/get/getBooks.php",
          on: {
            onItemClick: function (id) {
              var unitName = this.getItem(id).name;
              window.selectedBook = unitName;
              window.selectedBookID = this.getItem(id).ID;
              $$("deleteBook").enable();
              $$("viewBook").enable();
              $$("reuploadBook").enable();
              $$('reuploadBook').data.upload = "../ajax/upload/uploadBook.php?bookName=" + window.selectedBook;

            },
            onAfterEditStop: function (state, editor) {
              var THIS = this;
              if (state.value != state.old) {
                // editor.column is name or longname
                $.ajax("../ajax/rename/renameBook.php?" + editor.column + "=" + state.value + "&id=" + window.selectedBookID + "&oldname=" + state.old).done(
                    function (ret) {
                      if (ret == "done") {
                        webix.message("Changes to " + editor.column + " saved.");
                      } else if (ret == "taken") {
                        var sel = THIS.getSelectedId();
                        var row = THIS.getItem(sel.row);
                        row.name = state.old;
                        THIS.updateItem(sel.row,row);
                        THIS.refresh();
                        webix.message("Name already taken! Rename to something else.");
                      } else {
                        document.body.innerHTML = ret;
                      }
                    }
                );
              }
            }
          }
        },
        {height: 20},
        {
          cols: [
            {},
            {
              value: "New", view: "button", on: {
              onItemClick: function () {
                $$("newBookCont").expand();
                $$("selectBook").collapse();
              }
            }
            },
            {},
            {value: "View", id:"viewBook", view: "button", disabled:true, on:{onItemClick:function() {
              window.location.href = window.selectedBookID + "/index.php";
            }}},
            {},
            {
              view: "uploader",
              id: "reuploadBook",
              disabled: true,
              view: "uploader",
              width: 200,
              value: "Reupload",
              upload: "../ajax/upload/uploadBook.php",
              on: {
                onUploadComplete: function () {
                  webix.message("Upload complete!");
                  window.location.href = window.location.href;
                }
              },
            },
            {},
            {
              value: "Delete", id: "deleteBook", view: "button", css: "delete", disabled: true, on: {
              onItemClick: function () {
                var url = "../ajax/delete/deleteBook.php?bookName=" + window.selectedBook;
                deletePrompt(window.selectedBook, "book", url, false)
              }
            }
            },
            {},
          ],
        },
        {height: 20},
      ],
    },
  };

  webix.ui({
    view: "scrollview",
    width: "100%",
    body: {
      type: "space",
      rows: [
        header,
        selectBook,
        newBook,
      ]
    }
  });


</script>
</body>
</html>